name: CI

on:
  push:
    branches: [ main, flutter_keycheck_v3 ]
    paths:
      - "lib/**"
      - "bin/**"
      - "test/**"
      - "pubspec.yaml"
      - ".github/workflows/ci.yml"
  pull_request:
    branches: [ main ]
    paths:
      - "lib/**"
      - "bin/**"
      - "test/**"
      - "pubspec.yaml"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
        with: { sdk: stable }
      - name: Cache pub/.dart_tool
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: pub-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-
      - run: dart pub get
      - run: dart analyze --fatal-infos --fatal-warnings

  test-blocking:
    runs-on: ubuntu-latest
    needs: analyze
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
        with: { sdk: stable }
      - name: Cache pub/.dart_tool
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: pub-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-
      - run: dart pub get
      - name: Prepare reports dir (cross-platform)
        shell: bash
        run: '[ -d reports ] || mkdir -p reports'
      - name: Fast blocking suite (exclude nonblocking)
        run: dart test --chain-stack-traces -j 2 -r compact --exclude-tags nonblocking